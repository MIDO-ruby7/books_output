# Webアプリケーションの機能別に見るセキュリティバグ
## 4-1 Webアプリケーションの機能と脆弱性の対応
[![Image from Gyazo](https://i.gyazo.com/ce8972f41f8c4a8be46b354a3830214d.png)](https://gyazo.com/ce8972f41f8c4a8be46b354a3830214d)
脆弱性はどこで発生するのか
- HTMLの出力(クロスサイト・スクリプティング)
- HTTPヘッダの出力(HTTPヘッダ・インジェクション)
- SQL文の呼び出し(SQLインジェクション)
- シェルコマンドの呼び出し(OSコマンド・インジェクション)
- メールヘッダおよび本文の出力(メールヘッダ・インジェクション)


## 4-2 入力情報とセキュリティ
入力処理
- (a)文字エンコーディングの検証：mb_check_encoding関数、正当であればtureを返す
- (b)文字エンコーディングの変換：言語によって違う
- (c)入力値の妥当性検証：
- 上記があることでユーザービリティの向上やデータの不整合を防ぐ
- SQLインジェクション対策が漏れていた場合などに役立つ場合もある
- バイナリセーフ：入力値がどんなバイト列であっても正しく扱えることを意味する。特にヌルバイト
- ヌルバイト攻撃：
- ヌルバイト攻撃に対する根本的な解決策は、バイナリセーフの関数のみを用いてアプリケーションを開発することですが、ファイル名など仕様上それを許容しないパラメータがあり、現実にそれは困難である。
- このため、アプリケーションの入り口でバイナリセーフ関数を用いて入力値のヌルバイトをチェックし、ヌルバイトがあればエラーにする
- 入力値検証だけでは対策にならない
- 制御文字のチェック、文字数のチェック、数値の最小値・最大値のチェック

## 4-3表示処理に伴う問題
表示処理が原因で発生するセキュリティ上の問題にはクロスサイト・スクリプティングとエラーメッセージからの情報漏洩がある
#### クロスサイト・スクリプティング(XSS)
XSSの脆弱性があると...
- ブラウザ上で攻撃者の用意したスクリプトの実行によりクッキー値を盗まれ、利用者がなりすましにあう
- ブラウザ上で攻撃者の用意したスクリプトの実行によりサイト利用者の権限でWebアプリケーションの機能を悪用される
- Webサイト上に偽の入力フォームが表示され、フィッシングにより利用者が個人情報を盗まれる(画面の書き換え)
[![Image from Gyazo](https://i.gyazo.com/148dcfdbba8b462cb7a97df61b3adee0.png)](https://gyazo.com/148dcfdbba8b462cb7a97df61b3adee0)

- 画面の書き換えの場合、URLは元のサイトのものと変わらず、httpsサイトだった場合の証明書も正規のものになる
- 反射型XSS：攻撃用JSが攻撃対象サイトとは別のサイトにある場合：入力値をそのまま表示するページに多い
- 持続型SSX：攻撃用JSが攻撃対象のDBなどに保存される場合：SNSやWebメールなどがターゲット。罠サイトに誘導する必要がなく、注意深くても被害に遭う可能性が高い
- 脆弱性が生まれる原因：メタ文字を正しく扱っていない。HTMLのエスケープはXSS解消のために非常に重要
- 例：HTML上で">"という文字を表示させたい→"&lt;"とエスケープせず"<"と記載→ブラウザは開始タグと解釈し悪用される
- 属性値を""で囲む

##### XSS対策の基本
- 要素内容については"<","&"をエスケープする
- 属性値については""で囲って"<","&"
- HTTPレスポンス文字にエンコーディングを明示
- 保険的対策としてX-XSS-Protectionレスポンスヘッダを使用する(ブラウザ側の機能。無効にしない)、入力値の検証、クッキーにHttpOnly属性を付与する(JSからのクッキーの読み出しを禁止する)


#### クロスサイト・スクリプティング(発展編)
